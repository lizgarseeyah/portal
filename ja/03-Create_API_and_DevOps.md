# Finish the Ice Cream Ratings API

## Background

Best For You Organics Company (BFYOC) has begun creation of a mobile application and public facing website, both of which will be used by customers to submit ratings and feedback of their ice cream. Both the website and application will be calling a set of APIs. BFYOC would like your team to create APIs to allow customers to submit ratings, and for business users to retrieve the ratings for reporting purposes.

It's difficult to predict the load generated by user reviews which can be impacted by several factors. Introduction or cancellation of a flavor
will cause a spike in reviews, as will local events, like concerts or an unexpected heatwave. As a result, the solution you implement must be able to scale dynamically, and minimize costs whenever possible.

BFYOC would like to ensure that the proper engineering fundamentals are implemented from the beginning of the application development and want to ensure the team establishes a pipeline where updates are [integrated](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-integration/) and [deployed](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-delivery/) continuously. For compliance reasons, they also need to be able to track changes, and rollback any deployments as necessary.

## Challenge

### Setup

Your team has been asked to implement a solution that will automatically deploy the Ratings API. The solution also needs to allow for rolling back any deployments, and tracking all changes made to the code.

Your solution should handle automatically building the code every time it is checked/merged in to the `master` branch and generate an artifact that can be deployed. Assuming the build succeeds and applicable unit tests pass, the artifact should then be automatically deployed to an instance of your Ratings API.

Take this opportunity to discuss as a team how you will be working as team. Implement the appropriate branching strategies that will enable collaboration.

### API Development

This challenge will require information about Users and Products. Three APIs have already been created for getting info about Users and Products:

* [Get Products](https://serverlessohproduct.trafficmanager.net/api/GetProducts)
* [Get Product](https://serverlessohproduct.trafficmanager.net/api/GetProduct) (expects a `productId` query parameter in the URL)
* [Get User](https://serverlessohuser.trafficmanager.net/api/GetUser) (expects a `userId` query parameter in the URL)

You now should work together as a team to create an Azure Function App in your Azure subscription that will implement the Ice Cream Ratings part of the API.

Your challenge is to define, create and deploy three functions in this function app:

#### CreateRating

* **Verb**: POST
* **Input payload example**:

```JSON
{
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

* **Requirements**
    * Validate both `userId` and `productId` by calling the existing API endpoints. You can find a user id to test with from the sample payload above
    * Add a property called `id` with a GUID value
    * Add a property called `timestamp` with the current UTC date time
    * Validate that the `rating` field is an integer from 0 to 5
    * Use a data service to store the ratings information to the backend
    * Return the entire review JSON payload with the newly created `id` and `timestamp`

* **Output payload example**:

```JSON
{
  "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "timestamp": "2018-05-21 21:27:47Z",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

#### GetRating

* **Verb**: GET
* **QueryString or route parameter**: `ratingId`
* **Requirements**
    * Get the rating from your database and return the entire JSON payload for the review identified by the id
* **Output payload example**:

```JSON
{
  "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "timestamp": "2018-05-21 21:27:47Z",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

#### GetRatings

* **Verb**: GET
* **QueryString or route parameter**: `userId`
* **Requirements**
    * Get the ratings for the user from your database and return the entire JSON payload for the reviews for the user identified by the id
* **Output payload example**:

``` JSON
[
  {
    "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
    "userId": "cc20a6fb-a91f-4192-874d-132493685376",
    "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
    "timestamp": "2018-05-21 21:27:47Z",
    "locationName": "Sample ice cream shop",
    "rating": 5,
    "userNotes": "I love the subtle notes of orange in this ice cream!"
  },
  {
    "id": "8947f7cc-6f4c-49ed-a7aa-62892eac8f31",
    "userId": "cc20a6fb-a91f-4192-874d-132493685376",
    "productId": "e4e7068e-500e-4a00-8be4-630d4594735b",
    "timestamp": "2018-05-20 09:02:30Z",
    "locationName": "Another Sample Shop",
    "rating": 4,
    "userNotes": "I really enjoy this grape ice cream!"
  }
]
```

Besides tools like Curl and Postman, you can use [the Rating Test Website](https://softserverless-rating.trafficmanager.net/)
to test your CreateRating method.

**Hint**: If using the Rating Test Website make sure to add the
[https://softserverless-rating.trafficmanager.net/](https://softserverless-rating.trafficmanager.net/)
website url to your function's
CORS rules!

## Success Criteria

* Have the rating API functions' code in source control

* Demonstrate a working CI/CD pipeline for your team's coaches

* Provide your coach the three endpoint URLs. The coach should be able to make a call to each of the endpoints and get successful results

* The coach should be able to use `GetRating` and `GetRatings` to query for ratings that the coach creates with `CreateRating`

* The endpoints should return standard HTTP status codes. For example, 404 when items are not found.

## References

* [What is Continuous Integration?](https://docs.microsoft.com/devops/develop/what-is-continuous-integration)
* [What is Continuous Delivery?](https://docs.microsoft.com/devops/deliver/what-is-continuous-delivery)
* [Continuous deployment for Azure Functions](https://docs.microsoft.com/azure/azure-functions/functions-continuous-deployment)
* [Azure DevOps Pipelines](https://docs.microsoft.com/azure/devops/pipelines/get-started/?view=azure-devops)
* [Git Actions Azure Functions Action](https://github.com/marketplace/actions/azure-functions-action)
* [Deploy Azure Functions with Jenkins](https://docs.microsoft.com/azure/jenkins/jenkins-azure-functions-deploy)
* [Deploy Azure Functions with Octopus Deploy](https://octopus.com/blog/azure-functions)
* Review the [Supported Languages in Azure Functions](https://docs.microsoft.com/azure/azure-functions/supported-languages)
  guide and go into the specific guide for the language you are using
* [Azure Functions triggers and bindings concepts](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings)
* [Introduction to Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/introduction)
* [Azure Cosmos DB bindings for Azure Functions](https://docs.microsoft.com/azure/azure-functions/functions-bindings-cosmosdb-v2)
* [Azure Functions HTTP and webhook bindings](https://docs.microsoft.com/azure/azure-functions/functions-bindings-http-webhook)
* [Store unstructured data using Azure Functions and Azure Cosmos DB](https://docs.microsoft.com/azure/azure-functions/functions-integrate-store-unstructured-data-cosmosdb)
* [Getting started with JSON features in Azure SQL Database](https://docs.microsoft.com/azure/sql-database/sql-database-json-features)
* [Azure Table storage overview](https://docs.microsoft.com/azure/cosmos-db/table-storage-overview)

## Progress Diagram

![Ratings API progress diagram](https://serverlessoh.azureedge.net/public/ratings-api-progress-diagram.jpg)

# アイス クリーム レーティング API を完成させる

## 背景

Best For You Organics Company (BFYOC) は、アイス クリームの評価とフィードバックを投稿できる顧客向けのモバイル アプリと Web サイトの作成に乗り出しました。モバイル アプリと Web サイトのどちらも一連の API を呼び出す考えです。皆さんのチームは BFYOC の依頼を受け、顧客がレーティングを投稿するための API と、社内業務ユーザーがそのレーティングをレポート作成用に取得するための API を作成します。

ユーザー レビューの量は、さまざまな要因により変化するため予測が困難で、フレーバーの追加や終了、コンサートなどの地域のイベント、予測以上の猛暑などにより急増することがあります。そのため、実装するソリューションには、動的にスケーリングできることと、可能な限りコストを最小化することが求められます。

BFYOC は、アプリケーション開発の初期段階からエンジニアリングの基礎が適切に実装されていることを望んでいます。チームに対しては、更新の[継続的インテグレーション (英語)](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-integration/) と[継続的デプロイメント (英語)](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-delivery/) のためのパイプラインを確立することを要望しています。コンプライアンス上の理由から、変更の追跡や必要に応じたデプロイメントのロールバックなどにも対応する必要があります。

## 課題

### 構想

Ratings API を自動的にデプロイするソリューションを実装します。このソリューションでは、任意のデプロイメントをロールバックできることと、コードの変更すべてを追跡できる必要があります。

またこのソリューションでは、コードを `master` ブランチにチェックイン/マージするたびにそのコードを自動的にビルドし、デプロイする成果物を生成できるようにします。ビルドが成功し、適用可能な単体テストに合格したら、その成果物を Ratings API のインスタンスに自動的にデプロイする必要があります。

このタイミングで、チームとしてどのように動くかを話し合ってください。共同作業を可能にする適切なブランチ戦略を立てましょう。

### API 開発

この課題には、ユーザーと商品の情報が必要です。ユーザーと商品の情報を取得するための 3 つの API が既に用意されています。

* [Get Products](https://serverlessohproduct.trafficmanager.net/api/GetProducts)
* [Get Product](https://serverlessohproduct.trafficmanager.net/api/GetProduct) (URL 内に `productId` クエリ パラメーターが必要)
* [Get User](https://serverlessohuser.trafficmanager.net/api/GetUser) (URL 内に `userId` クエリ パラメーターが必要)

ここからはチームで協力して、Azure サブスクリプション内に Azure Functions 関数アプリを作成し、そこにアイス クリームのレーティングに関する API パーツを実装します。

次の 3 つの関数を定義、作成し、関数アプリにデプロイします。

#### CreateRating

* **動詞**: POST
* **入力ペイロードの例**

```JSON
{
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

* **要件**
    * 既存の API エンドポイントを呼び出して `userId` と `productId` の有効性をチェックします。テスト用のユーザー ID は、上記のサンプル ペイロードのものを使用できます。
    * GUID 値を扱う `id` プロパティを追加します。
    * その時点の UTC 日時を扱う `timestamp` プロパティを追加します。
    * `rating` フィールドが 0 ～ 5 の整数であることをチェックします。
    * データ サービスを使用して、レーティング情報をバックエンドに保存します。
    * 新たに作成した `id` と `timestamp` を含むレビュー情報全体を JSON ペイロードで返します。

* **出力ペイロードの例**

```JSON
{
  "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "timestamp": "2018-05-21 21:27:47Z",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

#### GetRating

* **動詞**: GET
* **クエリ文字列またはルート パラメーター**: `ratingId`
* **要件**
    * データベースからレーティング情報を取得します。ID で識別されるレビュー情報を JSON ペイロードで返します。
* **出力ペイロードの例**

```JSON
{
  "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
  "userId": "cc20a6fb-a91f-4192-874d-132493685376",
  "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
  "timestamp": "2018-05-21 21:27:47Z",
  "locationName": "Sample ice cream shop",
  "rating": 5,
  "userNotes": "I love the subtle notes of orange in this ice cream!"
}
```

#### GetRatings

* **動詞**: GET
* **クエリ文字列またはルート パラメーター**: `userId`
* **要件**
    * 特定のユーザーによるレーティングをデータベースから取得します。この ID で識別されるユーザーのレビュー情報すべてを JSON ペイロードで返します。
* **出力ペイロードの例**

``` JSON
[
  {
    "id": "79c2779e-dd2e-43e8-803d-ecbebed8972c",
    "userId": "cc20a6fb-a91f-4192-874d-132493685376",
    "productId": "4c25613a-a3c2-4ef3-8e02-9c335eb23204",
    "timestamp": "2018-05-21 21:27:47Z",
    "locationName": "Sample ice cream shop",
    "rating": 5,
    "userNotes": "I love the subtle notes of orange in this ice cream!"
  },
  {
    "id": "8947f7cc-6f4c-49ed-a7aa-62892eac8f31",
    "userId": "cc20a6fb-a91f-4192-874d-132493685376",
    "productId": "e4e7068e-500e-4a00-8be4-630d4594735b",
    "timestamp": "2018-05-20 09:02:30Z",
    "locationName": "Another Sample Shop",
    "rating": 4,
    "userNotes": "I really enjoy this grape ice cream!"
  }
]
```

CreateRating メソッドのテストには、Curl や Postman などのツールの他に、[レーティング テスト Web サイト (英語)](https://softserverless-rating.trafficmanager.net/) も使用できます。

**ヒント**: レーティング テスト Web サイトを使用する場合は、関数の CORS ルールに [https://softserverless-rating.trafficmanager.net/ (英語)](https://softserverless-rating.trafficmanager.net/) という Web サイトの URL を追加します。

## 成功条件

* Ratings API 関数のコードをソース管理に組み込む。

* 動作している CI/CD パイプラインをコーチに見せる。

* 3 つのエンドポイントの URL をコーチに示す。コーチが各エンドポイントを呼び出して、正常な応答が返されることを確認する。

* コーチが `CreateRating` を使ってレーティングを作成し、`GetRating` と `GetRatings` を使ってレーティング情報を照会できることを確認する。

* エンドポイントが標準的な HTTP ステータス コードを返す。たとえば、アイテムが見つからないときは 404 を返すようにする。

## 参考資料

* [継続的インテグレーションの概要 (英語)](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-integration/)
* [継続的デリバリーの概要 (英語)](https://docs.microsoft.com/azure/devops/learn/what-is-continuous-delivery/)
* [Azure Functions の継続的なデプロイ](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-continuous-deployment)
* [Azure の DevOps パイプライン (英語)](https://docs.microsoft.com/azure/devops/pipelines/get-started/?view=azure-devops)
* [Azure Functions アクション用 Git アクション (英語)](https://github.com/marketplace/actions/azure-functions-action)
* [Jenkins を使用した Azure Functions のデプロイ](https://docs.microsoft.com/ja-jp/azure/jenkins/jenkins-azure-functions-deploy)
* [Octopus Deploy を使用した Azure Functions のデプロイ (英語)](https://octopus.com/blog/azure-functions)
* [Azure Functions でサポートされている言語](https://docs.microsoft.com/ja-jp/azure/azure-functions/supported-languages): チームが使用する言語固有のガイドを参照してください。
* [Azure Functions でのトリガーとバインドの概念](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-triggers-bindings)
* [Azure Cosmos DB の概要](https://docs.microsoft.com/ja-jp/azure/cosmos-db/introduction)
* [Azure Functions の Azure Cosmos DB バインド](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-cosmosdb-v2)
* [Azure Functions の HTTP と Webhook のバインド](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-http-webhook?tabs=csharp)
* [Azure Functions と Azure Cosmos DB を使用して非構造化データを格納する](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-integrate-store-unstructured-data-cosmosdb?tabs=csharp)
* [Azure SQL Database の JSON 機能の概要](https://docs.microsoft.com/ja-jp/azure/sql-database/sql-database-json-features)
* [Azure Table Storage の概要](https://docs.microsoft.com/ja-jp/azure/cosmos-db/table-storage-overview)

## 進捗図

![進捗図: レーティング API](https://serverlessoh.azureedge.net/public/ratings-api-progress-diagram.jpg)
